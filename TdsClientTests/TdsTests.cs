using System;
using Medella.TdsClient.Contants;
using Medella.TdsClient.Exceptions;
using Medella.TdsClient.SNI.SniNp;
using Medella.TdsClient.TDS;
using Medella.TdsClient.TDS.Messages.Client;
using Medella.TdsClient.TDS.Messages.Server;
using Medella.TdsClient.TDS.Package;
using Medella.TdsClient.TDS.Processes;
using Xunit;

namespace TdsClientTests
{
    public class TdsTests
    {
        private const string ConnectionString = @"Server=(localdb)\mssqllocaldb;Database=tmp;Trusted_Connection=True;";
        private const string ConnectionString2 = @"Server=.;Database=tmp;Trusted_Connection=True;";

        [Fact]
        public void can_login()
        {
            var tds = Tds.GetConnection(ConnectionString);
            tds.ExecuteNonQuery("print 1");
            tds = Tds.GetConnection(ConnectionString);
            tds.ExecuteNonQuery("print 1");
        }

        [Fact]
        public void can_login_toSql()
        {
            var tds = Tds.GetConnection(ConnectionString2);
            tds.ExecuteNonQuery("print 1");
        }

        [Fact]
        public void can_read_a_large_column()
        {
            var tds = Tds.GetConnection(ConnectionString);
            var x = tds.ExecuteQuery<NotNullTypes>(TestStatements.NotNullTable);
        }

        [Fact]
        public void can_read_not_null_fields()
        {
            var tds = Tds.GetConnection(ConnectionString);
            var x = tds.ExecuteQuery<NotNullTypes>(TestStatements.NotNullTable);
        }

        [Fact]
        public void can_read_timestamp()
        {
            var tds = Tds.GetConnection(ConnectionString);
            var x = tds.ExecuteQuery<TestIntType>(@"DECLARE @zz timestamp; Select zz=@zz");
        }

        [Fact]
        public void can_Serailize_all_nulls()
        {
            var tds = Tds.GetConnection(ConnectionString);
            var x = tds.ExecuteQuery<TestNullType>(TestStatements.SelectAllNullTypes);
            var v = x[0];
            Assert.Null(v.a);
            Assert.Null(v.b);
            Assert.Null(v.c);
            Assert.Null(v.d);
            Assert.Null(v.e);
            Assert.Null(v.f);
            Assert.Null(v.g);
            Assert.Null(v.h);
            Assert.Null(v.i);
            Assert.Null(v.j);
            Assert.Null(v.k);
            Assert.Null(v.l);
            Assert.Null(v.m);
            Assert.Null(v.n);
            Assert.Null(v.o);
            Assert.Null(v.p);
            Assert.Null(v.q);
            Assert.Null(v.r);
            Assert.Null(v.s);
            Assert.Null(v.t);
            Assert.Null(v.u);
            Assert.Null(v.v);
            Assert.Null(v.w);
            Assert.Null(v.x);
            Assert.Null(v.y);
            Assert.Null(v.z);
            Assert.Null(v.zz);
        }

        [Fact]
        public void can_Serailize_normal_sqltype_to_object()
        {
            var tds = Tds.GetConnection(ConnectionString);
            var x = tds.ExecuteQuery<TestNullType>(TestStatements.SelectAllNotNullTypes);
            var v = x[0].a == null ? x[1] : x[0];
            Assert.Equal(new DateTime(2018, 12, 31), v.a);
            Assert.Equal(new TimeSpan(10, 11, 12), v.b);
            Assert.Equal(new DateTime(2018, 12, 31, 10, 11, 12), v.c);
            Assert.Equal(new DateTimeOffset(2018, 12, 31, 10, 11, 12, new TimeSpan(5, 0, 0)), v.d);
            Assert.True(v.e);
            Assert.Equal((byte?) 1, v.f);
            Assert.Equal((short?) 1, v.g);
            Assert.Equal(1, v.h);
            Assert.Equal(1, v.i);
            Assert.Equal(1, v.j);
            Assert.Equal(1, v.k);
            Assert.Equal(1, v.l);
            Assert.Equal(1, v.m);
            Assert.Equal(new DateTime(2018, 12, 31), v.n);
            Assert.Equal(new DateTime(2018, 12, 31), v.o);
            Assert.Equal(new Guid("9e383328-69d7-4e73-8126-e25a1be94ae9"), v.p);
            Assert.Equal(new byte[] {1}, v.q);
            Assert.Equal(new byte[] {49, 50, 51, 52, 53, 54, 55, 56, 57}, v.r);
            Assert.Equal(new[] {'1'}, v.s);
            Assert.Equal("123456789", v.t);
            Assert.Equal(new[] {'1'}, v.u);
            Assert.StartsWith("123456789", v.v);
            Assert.Equal(1, v.x);
            Assert.Equal(1_000_000_000_000_000_000, v.y);
            Assert.Equal(9_999_999_999_999_999_583_119_736_832M, v.z);
            Assert.Equal(new byte[] {0, 0, 0, 0, 0, 0, 0, 1}, v.zz);
        }

        [Fact]
        public void can_Serailize_normal_varianttype_to_object()
        {
            var tds = Tds.GetConnection(ConnectionString);
            var x = tds.ExecuteQuery<TestNullType>(TestStatements.SelectAllVariantTypes);
            var v = x[0].a == null ? x[1] : x[0];
            Assert.Equal(new DateTime(2018, 12, 31), v.a);
            Assert.Equal(new TimeSpan(10, 11, 12), v.b);
            Assert.Equal(new DateTime(2018, 12, 31, 10, 11, 12), v.c);
            Assert.Equal(new DateTimeOffset(2018, 12, 31, 10, 11, 12, new TimeSpan(5, 0, 0)), v.d);
            Assert.True(v.e);
            Assert.Equal((byte?) 1, v.f);
            Assert.Equal((short?) 1, v.g);
            Assert.Equal(1, v.h);
            Assert.Equal(1, v.i);
            Assert.Equal(1, v.j);
            Assert.Equal(1, v.k);
            Assert.Equal(1, v.l);
            Assert.Equal(1, v.m);
            Assert.Equal(new DateTime(2018, 12, 31), v.n);
            Assert.Equal(new DateTime(2018, 12, 31), v.o);
            Assert.Equal(new Guid("9e383328-69d7-4e73-8126-e25a1be94ae9"), v.p);
            Assert.Equal(new byte[] {1}, v.q);
            Assert.Equal(new[] {'1'}, v.s);
            Assert.Equal(new[] {'1'}, v.u);
            Assert.Equal(1, v.x);
            Assert.Equal(1_000_000_000_000_000_000, v.y);
            Assert.Equal(9_999_999_999_999_999_583_119_736_832M, v.z);
        }

        [Fact]
        public void Connection_returned_cleaned_to_the_pool()
        {
            var cnn = Tds.GetConnection(ConnectionString);
            var cnninternal = cnn.GetConnection();

            cnninternal.ExecuteNonQuery("print 1");
            Assert.Equal(3, cnninternal.SqlMessages.Count);
            cnn.Return(cnninternal);


            cnninternal = cnn.GetConnection();
            cnninternal.ExecuteNonQuery("print 1");
            Assert.Equal(3, cnninternal.SqlMessages.Count);
            cnn.Return(cnninternal);

            cnninternal = cnn.GetConnection();
            Assert.Equal(2, cnninternal.SqlMessages.Count);
            cnn.Return(cnninternal);
        }


        [Fact]
        public void get_connection_properties()
        {
            Assert.True(ServerConnectionOptions.IsNamedPipe(@"np:\\.\pipe\LOCALDB#678E2031\tsql\query".Split(@"\")));
            //Act
            var p = new ServerConnectionOptions(@"(localdb)\mssqllocaldb", false);
            //
            Assert.StartsWith(@"localdb#", p.PipeName);
            Assert.EndsWith(@"\tsql\query", p.PipeName);
            Assert.Equal(@".", p.PipeServerName);

            //Act
            p = new ServerConnectionOptions(@"tcp:localhost,1444", false);
            //
            Assert.Equal(@"localhost", p.IpServerName);
            Assert.Null(p.InstanceName);
            Assert.Equal(1444, p.IpPort);
            Assert.False(p.IsSsrpRequired);
            //Act
            p = new ServerConnectionOptions(@"tcp:localhost\instance", false);
            //Assert
            Assert.Equal(@"localhost", p.IpServerName);
            Assert.Equal("instance", p.InstanceName);
            Assert.Equal(-1, p.IpPort);
            Assert.True(p.IsSsrpRequired);
        }

        [Fact]
        public void get_npSniHandle()
        {
            const bool marsOn = false;
            var p = new ServerConnectionOptions(@"(localdb)\mssqllocaldb", false);
            var handle = new SniNpHandle(p.PipeServerName, p.PipeName, 15);
            var writer = new TdsPackageWriter(handle);
            var reader = new TdsPackageReader(handle);

            writer.SendPreLoginHandshake("", marsOn);
            var status = reader.ReadPackage();
            Assert.Equal(TdsEnums.ST_EOM, status);
            var result = ParserPreLogin.ParsePreLoginHandshake(reader.ReadBuffer, TdsEnums.HEADER_LEN, EncryptionOptions.OFF);
            Assert.Equal(EncryptionOptions.OFF, result);
        }

        [Fact]
        public void ReadLargeColumn()
        {
            var cnn = Tds.GetConnection(ConnectionString);
            var result = cnn.ExecuteQuery<TestLongStringType>(@"
                DECLARE @v nvarchar(max)=CAST( replicate('1',32768) AS nvarchar(max) )
                SELECT s=@v");
            Assert.Equal(8000, result[0].s.Length);
        }

        [Fact]
        public void ReadLargeColumn2()
        {
            var tds = Tds.GetConnection(@"Server=(localdb)\mssqllocaldb;Database=tmp;Trusted_Connection=True;");
            {
                var result = tds.ExecuteQuery<TestLongStringType>(@"SELECT s=test FROM TestVarCharmax");
                Assert.Equal(16000, result[0].s.Length);
            }
        }

        [Fact]
        public void ReadWmptyXml()
        {
            var tds = Tds.GetConnection(@"Server=(localdb)\mssqllocaldb;Database=tmp;Trusted_Connection=True;");
            {
                var result = tds.ExecuteQuery<TestLongStringType>(@"SELECT s=cast('' as xml)");
                ;
                Assert.Equal(0, result[0].s.Length);
            }
        }

        [Fact]
        public void ReadXml()
        {
            var tds = Tds.GetConnection(@"Server=(localdb)\mssqllocaldb;Database=tmp;Trusted_Connection=True;");
            {
                var result = tds.ExecuteQuery<TestLongStringType>(@"
DECLARE @v xml=CAST( '<Data><DepartmentID>x</DepartmentID></Data>' AS xml )
SELECT s=@v");
                ;
                Assert.Equal(43, result[0].s.Length);
            }
        }
    }

    public class UdtTests
    {
        private const string ConnectionString = @"Server=(localdb)\mssqllocaldb;Database=test;Trusted_Connection=True;";

        [Fact]
        public void can_read_Udt()
        {

            var cnn = Tds.GetConnection(ConnectionString);
            cnn.ExecuteNonQuery(TestStatement);
            var x = cnn.ExecuteQuery<UdtTypes>("DECLARE @u Utf8String = CONVERT(Utf8String, 'hello world') SELECT Utf8String=@u");
            Assert.Equal(0, x[0].Utf8String.Length);
        }
        public static string TestStatement = @"
        IF EXISTS (SELECT * FROM sys.types WHERE name = N'Utf8String') DROP TYPE [Utf8String]; 
        IF EXISTS (SELECT * FROM sys.assemblies WHERE name = N'UTF8String') DROP ASSEMBLY UTF8String; 
        CREATE ASSEMBLY [UTF8String] FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300A346F45A0000000000000000E00022200B013000000A0000000600000000000006290000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000B42800004F00000000400000B002000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E746578740000000C09000000200000000A000000020000000000000000000000000000200000602E72737263000000B00200000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001000000000000000000000000000004000004200000000000000000000000000000000E8280000000000004800000002000500F0200000C407000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004202280600000A000002037D010000042A1E027B010000042A360F00280700000A73010000062A2E0203280A00000616FE012A3A022D03162B0702036F0800000A2A2E0203280500000616FE012A46022D03162B0A0203280A00000616FE042A46022D03162B0A0203280A00000616FE022A4E026F0900000A252D0426162B056F0A00000A2A0A162A1E1473010000062A2602280600000A00002A0A002A000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000C4020000237E0000300300007402000023537472696E677300000000A40500000400000023555300A8050000100000002347554944000000B80500000C02000023426C6F6200000000000000020000015717A0010900000000FA013300160000010000001000000002000000010000000F0000000E000000030000000A00000005000000010000000200000002000000010000000200000000005C010100000000000600BD00FF010600DD00FF0106008D00EC010F001F0200000A004A02CB010A00A100CB01060051027F010A0058002E02060062007F010A000B01CB010A007A00CB010A003400CB010A002E00CB010A003B012E020600BE010A000600AB010A00000000000100000000000100010001201000430000001D0001000100010032012C005020000000008618E6012F000100612000000000C6004F011600020069200000000096006E0034000200772000000000C60043021A00030083200000000096085A023B000400922000000000960866023B0006009E2000000000960895013B000800B02000000000960886013B000A00C22000000000C6004C001F000C00D62000000000E601A10143000C00D9200000000096086B0148000D00D62000000000E60974014D000D00E120000000008618E60106000D00EB2000000000E601740051000D00EB2000000000E601290057000E0000000100050100000100450100000100580100000100270100000200B80100000100270100000200B80100000100270100000200B80100000100270100000200B80100000100580100000100580200000100EA010200210002002500020029000900E60101001100E60106001900E6010A003100E60110005900E60106003900E60106007100FB001600390043021A0039004F01160039004C001F002E000B0066002E0013006F002E001B008E0040002B00970043002300DF010200010000007A015D0000007801620002000B00030002000C0005000480000000000000000000000000000000001C010000040000000000000000000000230020000000000004000000000000000000000023001400000000000000003C4D6F64756C653E0053797374656D2E494F0053797374656D2E44617461006D73636F726C696200526561640053797374656D446174614163636573734B696E640044756D6D795574640047657448617368436F646500494E756C6C61626C650049436F6D70617261626C650050617273650057726974650053716C4D6574686F644174747269627574650044656275676761626C654174747269627574650053716C55736572446566696E65645479706541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C75650076616C7565004942696E61727953657269616C697A650055746638537472696E670075746638537472696E67006D5F537472696E670053716C537472696E670073716C537472696E6700546F537472696E67006F626A0055746638537472696E672E646C6C006765745F4E756C6C006765745F49734E756C6C0053797374656D006F705F477265617465725468616E006F705F4C6573735468616E00436F6D70617265546F0042696E617279526561646572006F746865720042696E617279577269746572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C547970657300457175616C7300466F726D6174004F626A6563740077006F705F457175616C697479006F705F496E657175616C6974790000000000678D6CFA4953324696D5EAF5B73BA31A000420010108032000010520010111110520010111150320000E042001021C0320000808B77A5C561934E08902060E042001010E060001120811390700020212081208042001081C04000012080320000205200101123D0520010112410408001208032800020801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730108010007010000000081460100040054020F497344657465726D696E697374696301540209497350726563697365015455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D44617461416363657373000000002B010002000000020054020D4973427974654F7264657265640154080B4D61784279746553697A65401F000000DC2800000000000000000000F6280000002000000000000000000000000000000000000000000000E8280000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000540200000000000000000000540234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B4010000010053007400720069006E006700460069006C00650049006E0066006F0000009001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003E000F00010049006E007400650072006E0061006C004E0061006D0065000000550074006600380053007400720069006E0067002E0064006C006C00000000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000046000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000550074006600380053007400720069006E0067002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000083900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 WITH PERMISSION_SET = SAFE
        CREATE TYPE [Utf8String] EXTERNAL NAME [UTF8String].DummyUtd; 
        
    ";
    }

    public class UdtTypes
    {
        public byte[] Utf8String { get; set; }
    }
}